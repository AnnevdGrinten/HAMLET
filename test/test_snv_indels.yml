# snv-indel pipeline should attempt to generate specified files
- name: test-snv-indels-dry-run-trio
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --printshellcmds
    --configfile test/data/config/chrM.json
    --config pepfile=test/pep/chrM-trio.csv
  stdout:
    contains:
      - "TestSample1/snv-indels/TestSample1.variants_all.csv"
      - "TestSample1/snv-indels/TestSample1.variants_hi.csv"

      - "TestSample2/snv-indels/TestSample2.variants_all.csv"
      - "TestSample2/snv-indels/TestSample2.variants_hi.csv"

      - "TestSample3/snv-indels/TestSample3.variants_all.csv"
      - "TestSample3/snv-indels/TestSample3.variants_hi.csv"
    contains_regex:
      - "STAR .* ID:TestSample1 .* --readFilesIn 'test/data/fastq/SRR8615409 chrM_1.fastq.gz' 'test/data/fastq/SRR8615409 chrM_2.fastq.gz'"

# Singularity should be available
- name: test-snv-indels-sanity-singularity
  tags:
    - sanity
    - snv-indels
  command: >
    singularity --version
  stdout:
    contains_regex:
      - "singularity(-ce)? version 3"

# snv-indel pipeline should run successfully on chrM test data
- name: test-snv-indels-chrM
  tags:
    - functional
    - snv-indels
  command: >
    snakemake -rp
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/chrM.json
    --config pepfile=test/pep/chrM.csv
    --cores 1
    --notemp
    --verbose
    --use-singularity
    --singularity-args '--cleanenv --bind /tmp'
    --singularity-prefix '~/.singularity/cache/snakemake'
  stderr:
    # snv-indel should not use a local VEP database, but query ensembl
    must_not_contain_regex:
      - 'vep .* --offline'
  files:
    # Check to make sure the read group is set to the sample name
    - path: "SRR8615409/snv-indels/Log.out"
      contains_regex:
        - "outSAMattrRGline +ID:SRR8615409"
    - path: "SRR8615409/snv-indels/SRR8615409.snv-indel.bam"
    - path: "SRR8615409/snv-indels/SRR8615409.exon_cov_stats.json"
    - path: "SRR8615409/snv-indels/SRR8615409.annotated.vcf.gz"
      contains:
        # VEP output should be in VCF format
        - "##fileformat=VCFv4.1"
        # VEP output should contain HGVS annotations
        - "ENST00000361390.2:c.210C>A"
    - path: "SRR8615409/snv-indels/SRR8615409.aln_stats"
    - path: "SRR8615409/snv-indels/SRR8615409.variants.json"
    - path: "SRR8615409/snv-indels/SRR8615409.variants_all.csv"
    - path: "SRR8615409/snv-indels/SRR8615409.variants_hi.csv"
    # Test log files
    - path: "SRR8615409/snv-indels/Log.final.out"
      contains:
        - "Started job on"
    - path: "log/index_bamfile.SRR8615409.txt"
    - path: "log/reorder_aln_header.SRR8615409.txt"
      contains:
        - "ReorderSam"
    - path: "log/tmp.genome.txt"
    - path: "log/exon_cov_ref.txt"
    - path: "log/exon_cov.SRR8615409.txt"
    - path: "log/call_vars.SRR8615409.txt"
      contains:
        - "bin/varscan"
    - path: "log/aln_stats.SRR8615409.txt"
      contains:
        - "CollectAlignmentSummaryMetrics"
    - path: "log/insert_stats.SRR8615409.txt"
      contains:
        - "CollectInsertSizeMetrics"
    - path: "log/rna_stats.SRR8615409.txt"
      contains:
        - "CollectRnaSeqMetrics"
    - path: "log/annotate_vars.SRR8615409.txt"
    - path: "log/extract_vars.SRR8615409.txt"
    - path: "log/table_vars_all.SRR8615409.txt"
    - path: "log/table_vars_hi.SRR8615409.txt"
    - path: "log/plot_vars.SRR8615409.txt"
    - path: "SRR8615409/snv-indels/snv-indels-output.json"
    # Test the location of the variant plots
    - path: "SRR8615409/snv-indels/variant_plots/sample_SRR8615409_gene_MT-ATP6.png"
    - path: "SRR8615409/snv-indels/variant_plots/sample_SRR8615409_gene_MT-ATP8.png"
    # Test that a STAR counts file is generated
    - path: "SRR8615409/snv-indels/ReadsPerGene.out.tab"
      contains:
        - "N_unmapped"


# VEP should switch to offline mode when "cache_vep" is specified
- name: test-chrM-vep-cache
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --printshellcmds
    --configfile test/data/config/chrM-vep-cache.json
    --config pepfile=test/pep/chrM.csv
  stdout:
    contains_regex:
      - 'vep .* --offline'
    must_not_contain_regex:
      - 'vep .* --database'

- name: lint-snv-indels
  tags:
    - sanity
    - snv-indels
  command: >
    snakemake
    --lint
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/chrM.json
    --config pepfile=test/pep/chrM.csv

- name: snakefmt-snv-indels
  tags:
    - sanity
    - snv-indels
  command: snakefmt --check includes/snv-indels/
