- name: test-snv-indels-dry-run-single
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-dry-run-single.config
  stdout:
    contains:
      - "Job counts:"
      - "TestSample/snv-indels/variant_plots/.done"
      - "TestSample/snv-indels/TestSample.variants_all.csv"
      - "TestSample/snv-indels/TestSample.variants_hi.csv"

- name: test-snv-indels-dry-run-trio
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-dry-run-trio.config
  stdout:
    contains:
      - "Job counts:"
      - "TestSample1/snv-indels/variant_plots/.done"
      - "TestSample1/snv-indels/TestSample1.variants_all.csv"
      - "TestSample1/snv-indels/TestSample1.variants_hi.csv"

      - "TestSample2/snv-indels/variant_plots/.done"
      - "TestSample2/snv-indels/TestSample2.variants_all.csv"
      - "TestSample2/snv-indels/TestSample2.variants_hi.csv"

      - "TestSample3/snv-indels/variant_plots/.done"
      - "TestSample3/snv-indels/TestSample3.variants_all.csv"
      - "TestSample3/snv-indels/TestSample3.variants_hi.csv"

- name: test-snv-indels-sanity-singularity
  tags:
    - sanity
    - snv-indels
  command: >
    singularity --version
  stdout:
    contains_regex:
      - "singularity(-ce)? version 3"

- name: test-TET2-insertion-config
  tags:
    - integration
    - snv-indels
  command: >
    snakemake -rp
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-TET2-insertion.config
    --verbose
    --use-singularity
    7075-04-001-005/snv-indels/7075-04-001-005.raw.vcf.gz
  files:
    - path: "7075-04-001-005/snv-indels/7075-04-001-005.raw.vcf.gz"
      contains:
          - "chr4\t105259626\t.\tT\tTG"
      must_not_contain:
          - "chr4\t105259619\t.\tG\tA"
          - "chr4\t105259620\t.\tA\tG"
          - "chr4\t105259621\t.\tG\tA"
          - "chr4\t105259623\t.\tA\tC"
          - "chr4\t105259624\t.\tC\tT"
          - "chr4\t105259626\t.\tT\tG"

- name: test-RUNX1-insertion
  tags:
    - integration
    - snv-indels
  command: >
    snakemake -rp
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-RUNX1-insertion.config
    --verbose
    --use-singularity
    "7075-04-001-002/snv-indels/7075-04-001-002.raw.vcf.gz"
  files:
    - path: "7075-04-001-002/snv-indels/7075-04-001-002.raw.vcf.gz"
      contains:
        - "chr21\t34792223\t.\tA\tACGTCGCTCTGGTT"

- name: test-TET2-false-positive-mutation
  tags:
    - integration
    - snv-indels
  command: >
    snakemake -rp
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-TET2-mutation.config
    --verbose
    --use-singularity
    "7075-04-001-006/snv-indels/7075-04-001-006.raw.vcf.gz"
  files:
    - path: "7075-04-001-006/snv-indels/7075-04-001-006.raw.vcf.gz"
      must_not_contain:
        - "chr4\t105243576\t.\tC\tA"

- name: test-snv-indels-chrM
  tags:
    - functional
    - snv-indels
  command: >
    snakemake -rp
    --snakefile includes/snv-indels/Snakefile
    --configfile test/data/config/test-chrM.config
    --cores 1
    --notemp
    --verbose
    --use-singularity
    --singularity-args '--cleanenv --bind /tmp'
  stderr:
    must_not_contain_regex:
      - 'vep .* --offline'
    contains:
      - "rule index_reference"
  files:
    - path: "SRR8615409/snv-indels/SRR8615409.snv-indel.bam"
    - path: "SRR8615409/snv-indels/SRR8615409.exon_cov_stats.json"
    - path: "SRR8615409/snv-indels/SRR8615409.annotated.vcf.gz"
      # Make sure the VEP output is in VCF format
      contains:
        - "##fileformat=VCFv4.1"
    - path: "SRR8615409/snv-indels/SRR8615409.aln_stats"
    - path: "SRR8615409/snv-indels/SRR8615409.variants.json"
    - path: "SRR8615409/snv-indels/SRR8615409.variants_all.csv"
    - path: "SRR8615409/snv-indels/SRR8615409.variants_hi.csv"
    - path: "SRR8615409/snv-indels/variant_plots/.done"

# Test if VEP switches to offline mode when "cache_vep" is specified
- name: test-chrM-vep-cache
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --printshellcmds
    --configfile test/data/config/test-chrM-vep-cache.config
  stdout:
    contains_regex:
      - 'vep .* --offline'
    must_not_contain_regex:
      - 'vep .* --database'

# Test that index_reference is not ran if genome_gmap_index is specified
- name: test-chrM-gmap-index
  tags:
    - dry-run
    - snv-indels
  command: >
    snakemake -n
    --snakefile includes/snv-indels/Snakefile
    --printshellcmds
    --configfile test/data/config/test-chrM-gmap-index.config
  stdout:
    contains:
      - "gsnap --dir `dirname test/data/reference`"
    must_not_contain:
      - "rule index_reference"
