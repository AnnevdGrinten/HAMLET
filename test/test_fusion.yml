# Fusion pipeline should attempt to generate specified files
- name: test-fusion-dry-run-trio
  tags:
    - dry-run
    - fusion
  command: >
    snakemake -n
    --snakefile includes/fusion/Snakefile
    --printshellcmds
    --configfile test/data/config/fusion-dummy.json
    --config pepfile=test/pep/chrM-trio.csv
  stdout:
    contains:
      # fusion pipeline should generate the following files
      - "TestSample1/fusion/arriba/fusions.tsv"
      - "TestSample1/fusion/arriba/fusions.raw.tsv"
      - "TestSample1/fusion/arriba/fusions.raw.discarded.tsv"
      # fusion pipeline should handle multiple samples
      - "TestSample2/fusion/arriba/fusions.tsv"
      - "TestSample2/fusion/arriba/fusions.raw.tsv"
      - "TestSample2/fusion/arriba/fusions.raw.discarded.tsv"
      # fusion pipeline should create a final json file
      - "TestSample2/fusion/fusion-output.json"
      # arriba should be run
      - "rule arriba:"
      # arriba should create the figures
      - "rule plot_fusions:"
      # The fusion plot pdf should be split to png's
      - "rule split_fusion_plots:"
      # The final json output file should be produced
      - "TestSample1/fusion/fusion-output.json"
    must_not_contain:
      - "--fusion-partners"

# Singularity should be available
- name: test-fusion-sanity-singularity
  tags:
    - sanity
    - fusion
  command: >
    singularity --version
  stdout:
    contains_regex:
      - "singularity(-ce)? version 3"

# Fusion pipeline should run successfully
- name: test-fusion-chrM
  tags:
    - functional
    - fusion
  command: >
    bash -c "
    unxz -k test/data/reference/hamlet-ref.fa.xz;

    snakemake -rp
    --snakefile includes/fusion/Snakefile
    --configfile test/data/config/fusion.json
    --config pepfile=test/pep/chrM.csv
    --cores
    --notemp
    --verbose
    --use-singularity
    --singularity-args '--cleanenv --bind /tmp'
    --singularity-prefix '~/.singularity/cache/snakemake'

    rm test/data/reference/hamlet-ref.fa;
    "
  files:
    # Should create the arriba output files
    - path: SRR8615409/fusion/arriba/fusions.tsv
    - path: SRR8615409/fusion/arriba/fusions.raw.tsv
    - path: SRR8615409/fusion/arriba/fusions.raw.discarded.tsv
    # Test for module output file
    - path: "SRR8615409/fusion/fusion-output.json"
      contains_regex:
        - 'plot.*fusion-1.png'
    # Test for log files
    - path: "log/arriba.SRR8615409.txt"
      contains:
        - "WARNING"
    # Test that we split the fusion plot pfd to png
    - path: "SRR8615409/fusion/arriba/plots/fusion-1.png"
  stderr:
    must_not_contain:
      # We don't define any fusion partners in the configuration
      - "--fusion-partners"

- name: lint-fusion
  tags:
    - sanity
    - fusion
  command: >
    snakemake
    --lint
    --snakefile includes/fusion/Snakefile
    --configfile test/data/config/fusion.json
    --config pepfile=test/pep/chrM-bam.csv

- name: snakefmt-fusion
  tags:
    - sanity
    - fusion
  command: snakefmt --check includes/fusion
