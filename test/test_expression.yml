- name: Test dry run of expression module
  tags:
    - dry-run
    - expression
  command: >
    snakemake
    --snakefile includes/expression/Snakefile
    --workflow-profile test
    --dry-run
    --configfile test/data/config/expression.json
    --config pepfile=test/pep/expression.csv
  stdout:
    contains:
      - "rule merge_samples"
      

- name: Test error on unknown housekeeping gene
  tags:
    - sanity
    - expression
  command: >
    snakemake
    --snakefile includes/expression/Snakefile
    --workflow-profile test
    --dry-run
    --configfile test/data/config/expression.json
    --config pepfile=test/pep/expression.csv
             housekeeping="Z"
  exit_code: 1
  stdout:
    contains:
      - "Unknown housekeeping gene: Z"

- name: Test running the expression module
  tags:
    - functional
    - expression
  command: >
    snakemake
    --snakefile includes/expression/Snakefile
    --workflow-profile test
    --configfile test/data/config/expression.json
    --config pepfile=test/pep/expression.csv
  exit_code: 0
  files:
    - path: SRR8615409/expression/coverage.csv
      contains:
        - "MT-CO2\t282\t158\t124"
    # Since MT-CO2 was used both as gene of interest and only housekeeping
    # gene, the normalized expression for every strand must be 1.0
    # MT-CO2 was chosen specifically so it does not overlap any other
    # transcripts, which would be taken into account by STAR and give lower
    # counts
    - path: SRR8615409/expression/coverage.normalized.csv
      contains:
        - "MT-CO2\t1.0\t1.0\t1.0"
    # Test that the merged expression files are created, for unstranded,
    # forward and reverse libraries
    - path: merged_expression_unstranded_mqc.tsv
      contains:
        - "id: mqc_expression_unstranded"
    - path: merged_expression_forward_mqc.tsv
      contains:
        - "id: mqc_expression_forward"
    - path: merged_expression_reverse_mqc.tsv
      contains:
        - "id: mqc_expression_reverse"
    # Test that we create the multiqc report
    - path: multiqc_expression.html
      contains:
        - "MT-CO2"

- name: Check formatting of Snakemake files
  tags:
    - sanity
    - expression
  command: snakefmt --check includes/expression/
