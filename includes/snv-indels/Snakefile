from rattle import Run

RUN = Run(config)

# TODO: ensure db indices exist

rule align_vars:
    input:
        fq1=RUN.output("{sample}/{sample}-R1.fq.gz"),
        fq2=RUN.output("{sample}/{sample}-R2.fq.gz"),
        index=RUN.settings["genome_star_index"]
    output:
        bam=RUN.output("{sample}/snv-indels/{sample}.snv-indel.bam"),
        bai=RUN.output("{sample}/snv-indels/{sample}.snv-indel.bai"),
    params:
        rg_sample="{sample}"
    threads: 8
    conda: srcdir("envs/align_vars.yml")
    shell:
        "rm -rf `dirname {output.bam}`/alignment && "
        "mkdir -p `dirname {output.bam}`/alignment && "
        "STAR --outFileNamePrefix `dirname {output.bam}`/alignment/"
        " --genomeDir {input.index} --readFilesIn {input.fq1} {input.fq2}"
        " --readFilesCommand zcat --runThreadN {threads}"
        " --outStd SAM --outSAMunmapped Within --outFilterMultimapNmax 1"
        " --outSAMattrRGline ID:{params.rg_sample} SM:{params.rg_sample}"
        " | picard SortSam I=/dev/stdin O={output.bam} SORT_ORDER=coordinate"
        " VALIDATION_STRINGENCY=SILENT CREATE_INDEX=true"

rule call_vars:
    input:
        bam=RUN.output("{sample}/snv-indels/{sample}.snv-indel.bam"),
        ref=RUN.settings["genome_fasta"],
    output:
        vcf=RUN.output("{sample}/snv-indels/{sample}.raw.vcf.gz")
    threads: 3
    conda: srcdir("envs/call_vars.yml")
    shell:
        "samtools mpileup -f {input.ref} -d 1000000 -s -B {input.bam}"
        " | grep -vP '\\t\\t'"
        " | varscan mpileup2cns --strand-filter 0 --output-vcf 1 --min-var-freq 0.1 --p-value 0.05"
        " | grep -vP '\\t\./\.|\\t0/0'"
        " | bgzip -c > {output.vcf}"
